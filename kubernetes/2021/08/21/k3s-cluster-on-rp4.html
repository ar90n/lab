<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>k3sクラスタ on Raspberry Pi 4 | lab note</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="k3sクラスタ on Raspberry Pi 4" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="k3s cluster on Raspberry Pi 4" />
<meta property="og:description" content="k3s cluster on Raspberry Pi 4" />
<link rel="canonical" href="https://lab.ar90n.net/kubernetes/2021/08/21/k3s-cluster-on-rp4.html" />
<meta property="og:url" content="https://lab.ar90n.net/kubernetes/2021/08/21/k3s-cluster-on-rp4.html" />
<meta property="og:site_name" content="lab note" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-21T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"k3s cluster on Raspberry Pi 4","url":"https://lab.ar90n.net/kubernetes/2021/08/21/k3s-cluster-on-rp4.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lab.ar90n.net/kubernetes/2021/08/21/k3s-cluster-on-rp4.html"},"headline":"k3sクラスタ on Raspberry Pi 4","dateModified":"2021-08-21T00:00:00-05:00","datePublished":"2021-08-21T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://lab.ar90n.net/feed.xml" title="lab note" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-90473091-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">lab note</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">k3sクラスタ on Raspberry Pi 4</h1><p class="page-description">k3s cluster on Raspberry Pi 4</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-08-21T00:00:00-05:00" itemprop="datePublished">
        Aug 21, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#Kubernetes">Kubernetes</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#はじめに">はじめに</a></li>
<li class="toc-entry toc-h2"><a href="#やったこと">やったこと</a></li>
<li class="toc-entry toc-h2"><a href="#role関連の設定">Role関連の設定</a></li>
<li class="toc-entry toc-h2"><a href="#promtailの導入">promtailの導入　</a></li>
<li class="toc-entry toc-h2"><a href="#node-exporterの導入">node-exporterの導入</a></li>
<li class="toc-entry toc-h2"><a href="#lokiprometheusgrafanaの導入">loki，prometheus，grafanaの導入</a></li>
<li class="toc-entry toc-h2"><a href="#参考">参考</a></li>
</ul><h2 id="はじめに">
<a class="anchor" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB" aria-hidden="true"><span class="octicon octicon-link"></span></a>はじめに</h2>
<p>Raspberry Pi 4+k3sで構築したクラスタに関するメモです．</p>

<h2 id="やったこと">
<a class="anchor" href="#%E3%82%84%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>やったこと</h2>
<ul>
  <li>PC(master) + Raspberry Pi 4(worker)という構成でk3sクラスタを構築</li>
  <li>grafana + ptometheus + loki + node-exporter + promtailという構成で監視基盤を構築</li>
</ul>

<h2 id="role関連の設定">
<a class="anchor" href="#role%E9%96%A2%E9%80%A3%E3%81%AE%E8%A8%AD%E5%AE%9A" aria-hidden="true"><span class="octicon octicon-link"></span></a>Role関連の設定</h2>
<p>クラスタの監視を行うためには適切にサービスディスカバリを行う必要があります．そこで，サービスディスカバリに必要な権限を持つClusterRoleと対応するServiceAccountを定義します．
<code class="language-plaintext highlighter-rouge">/metrics</code>にアクセスするためには<code class="language-plaintext highlighter-rouge">Role</code>ではなく<code class="language-plaintext highlighter-rouge">ClusterRole</code>である必要があるようです．(<code class="language-plaintext highlighter-rouge">monitoring</code>ネームスペース外にアクセスするから？)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="pi">-</span> <span class="s">nodes/proxy</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">extensions</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ingresses</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">nonResourceURLs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/metrics"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
</code></pre></div></div>

<h2 id="promtailの導入">
<a class="anchor" href="#promtail%E3%81%AE%E5%B0%8E%E5%85%A5" aria-hidden="true"><span class="octicon octicon-link"></span></a>promtailの導入　</h2>
<p>とりあえず，ホストのログ(<code class="language-plaintext highlighter-rouge">/var/log/*log</code>)をmasterで稼働しているlokiに送信します．各podのログ収集については中途半端な設定となっています．（多分動かない）
各ログには<code class="language-plaintext highlighter-rouge">hostname</code>タグにホスト名を設定しています．これは，<code class="language-plaintext highlighter-rouge">spec.nodeName</code>を環境変数<code class="language-plaintext highlighter-rouge">NODE_NAME</code>に設定し，起動引数に<code class="language-plaintext highlighter-rouge">--client.external-labels=hostname=$(NODE_NAME)</code>を追加することで実現しています．</p>

<p>lokiはk3sクラスタ内ではなく，master上のDockerコンテナとしてホストされています．また，promtailはworkerとmaster両ノードにデプロイされます．
そのため，両環境下から<code class="language-plaintext highlighter-rouge">k3s-master</code>の名前解決を行うため，<code class="language-plaintext highlighter-rouge">dnsPolicy</code>を<code class="language-plaintext highlighter-rouge">None</code>として明示的にdnsサーバーを設定しています．
これは，<code class="language-plaintext highlighter-rouge">ClusterFirst</code>ではクラスタ外にある<code class="language-plaintext highlighter-rouge">k3s-master</code>の名前解決を行うことができず，<code class="language-plaintext highlighter-rouge">Default</code>ではworkerとmasterとで共通の舐め解決設定を作り出すことができなかったためです．</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">promtail-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">server:</span>
      <span class="s">http_listen_port: 9080</span>
      <span class="s">grpc_listen_port: 0</span>
    <span class="s">positions:</span>
      <span class="s">filename: /tmp/positions.yaml</span>
    <span class="s">clients:</span>
      <span class="s">- url: http://k3s-master:3100/loki/api/v1/push</span>
    <span class="s">scrape_configs:</span>
    <span class="s">- job_name: system</span>
      <span class="s">static_configs:</span>
      <span class="s">- targets:</span>
          <span class="s">- localhost</span>
        <span class="s">labels:</span>
          <span class="s">job: varlogs</span>
          <span class="s">__path__: /var/log/*log</span>
    <span class="s">- job_name: kubernetes-pods-app</span>
      <span class="s">kubernetes_sd_configs:</span>
      <span class="s">- role: pod</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">promtail</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">promtail</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">promtail</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">None</span>
      <span class="na">dnsConfig</span><span class="pi">:</span>
        <span class="na">nameservers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">10.0.100.1</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">monitoring</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">promtail</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/promtail:latest</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">TZ</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Asia/Tokyo</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">NODE_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">--config.file=/etc/promtail/config.yaml</span> 
        <span class="pi">-</span> <span class="s">--client.external-labels=hostname=$(NODE_NAME)</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">webui</span>
          <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9080</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/promtail</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">varlog</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/log</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/secrets</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">run</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/run/promtail</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">promtail-config</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">varlog</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/var/log</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret-volume</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/var/run/secrets</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">run</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/run/promtail</span>
</code></pre></div></div>

<h2 id="node-exporterの導入">
<a class="anchor" href="#node-exporter%E3%81%AE%E5%B0%8E%E5%85%A5" aria-hidden="true"><span class="octicon octicon-link"></span></a>node-exporterの導入</h2>
<p><code class="language-plaintext highlighter-rouge">node-exporter</code>もworkerとmaster両環境にデプロイされます．</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">monitoring</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">node-exporter</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">node-exporter</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
        <span class="s">prometheus.io/port</span><span class="pi">:</span> <span class="s1">'</span><span class="s">9100'</span>
        <span class="s">prometheus.io/path</span><span class="pi">:</span> <span class="s">/metrics</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">Default</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">monitoring</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">node-exporter</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">prom/node-exporter:latest</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">TZ</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">Asia/Tokyo</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">NODE_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">--path.procfs=/host/proc</span>
        <span class="pi">-</span> <span class="s">--path.sysfs=/host/sys</span>
        <span class="pi">-</span> <span class="s">--collector.filesystem.ignored-mount-points</span>
        <span class="pi">-</span> <span class="s">^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9100</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">proc</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/proc</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sys</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/sys</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">rootfs</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/rootfs</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">proc</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/proc</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sys</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/sys</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">rootfs</span>
        <span class="na">hostPath</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">/rootfs</span>
</code></pre></div></div>

<h2 id="lokiprometheusgrafanaの導入">
<a class="anchor" href="#lokiprometheusgrafana%E3%81%AE%E5%B0%8E%E5%85%A5" aria-hidden="true"><span class="octicon octicon-link"></span></a>loki，prometheus，grafanaの導入</h2>
<p>これらのソフトウェアはDockerコンテナとしてホストされています．<code class="language-plaintext highlighter-rouge">docker-compose.yml</code>は以下の通りです．</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.2"</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">monitoring</span><span class="pi">:</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">loki</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/loki:latest</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3100:3100"</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">-config.file=/etc/loki/local-config.yaml</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">bind</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">./loki/local-config.yml</span>
        <span class="na">target</span><span class="pi">:</span> <span class="s">/etc/loki/local-config.yaml</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">monitoring</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>

  <span class="na">grafana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/grafana:latest</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3000:3000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">bind</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">./grafana/provisioning</span>
        <span class="na">target</span><span class="pi">:</span> <span class="s">/etc/grafana/provisioning</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">volume</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">grafana_data</span>
        <span class="na">target</span><span class="pi">:</span> <span class="s">/var/lib/grafana</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">monitoring</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">grafana_data</span><span class="pi">:</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">local-config.yaml</code>は以下の通りです．デフォルトから特に変更していなかったと思います．</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">auth_enabled</span><span class="pi">:</span> <span class="no">false</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">http_listen_port</span><span class="pi">:</span> <span class="m">3100</span>

<span class="na">ingester</span><span class="pi">:</span>
  <span class="na">lifecycler</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="na">ring</span><span class="pi">:</span>
      <span class="na">kvstore</span><span class="pi">:</span>
        <span class="na">store</span><span class="pi">:</span> <span class="s">inmemory</span>
      <span class="na">replication_factor</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">final_sleep</span><span class="pi">:</span> <span class="s">0s</span>
  <span class="na">chunk_idle_period</span><span class="pi">:</span> <span class="s">1h</span>       <span class="c1"># Any chunk not receiving new logs in this time will be flushed</span>
  <span class="na">max_chunk_age</span><span class="pi">:</span> <span class="s">1h</span>           <span class="c1"># All chunks will be flushed when they hit this age, default is 1h</span>
  <span class="na">chunk_target_size</span><span class="pi">:</span> <span class="m">1048576</span>  <span class="c1"># Loki will attempt to build chunks up to 1.5MB, flushing first if chunk_idle_period or max_chunk_age is reached first</span>
  <span class="na">chunk_retain_period</span><span class="pi">:</span> <span class="s">30s</span>    <span class="c1"># Must be greater than index read cache TTL if using an index cache (Default index read cache TTL is 5m)</span>
  <span class="na">max_transfer_retries</span><span class="pi">:</span> <span class="m">0</span>     <span class="c1"># Chunk transfers disabled</span>

<span class="na">schema_config</span><span class="pi">:</span>
  <span class="na">configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span> <span class="s">2020-10-24</span>
      <span class="na">store</span><span class="pi">:</span> <span class="s">boltdb-shipper</span>
      <span class="na">object_store</span><span class="pi">:</span> <span class="s">filesystem</span>
      <span class="na">schema</span><span class="pi">:</span> <span class="s">v11</span>
      <span class="na">index</span><span class="pi">:</span>
        <span class="na">prefix</span><span class="pi">:</span> <span class="s">index_</span>
        <span class="na">period</span><span class="pi">:</span> <span class="s">24h</span>

<span class="na">storage_config</span><span class="pi">:</span>
  <span class="na">boltdb_shipper</span><span class="pi">:</span>
    <span class="na">active_index_directory</span><span class="pi">:</span> <span class="s">/loki/boltdb-shipper-active</span>
    <span class="na">cache_location</span><span class="pi">:</span> <span class="s">/loki/boltdb-shipper-cache</span>
    <span class="na">cache_ttl</span><span class="pi">:</span> <span class="s">24h</span>         <span class="c1"># Can be increased for faster performance over longer query periods, uses more disk space</span>
    <span class="na">shared_store</span><span class="pi">:</span> <span class="s">filesystem</span>
  <span class="na">filesystem</span><span class="pi">:</span>
    <span class="na">directory</span><span class="pi">:</span> <span class="s">/loki/chunks</span>

<span class="na">compactor</span><span class="pi">:</span>
  <span class="na">working_directory</span><span class="pi">:</span> <span class="s">/loki/boltdb-shipper-compactor</span>
  <span class="na">shared_store</span><span class="pi">:</span> <span class="s">filesystem</span>

<span class="na">limits_config</span><span class="pi">:</span>
  <span class="na">reject_old_samples</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">reject_old_samples_max_age</span><span class="pi">:</span> <span class="s">168h</span>

<span class="na">chunk_store_config</span><span class="pi">:</span>
  <span class="na">max_look_back_period</span><span class="pi">:</span> <span class="s">0s</span>

<span class="na">table_manager</span><span class="pi">:</span>
  <span class="na">retention_deletes_enabled</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">retention_period</span><span class="pi">:</span> <span class="s">0s</span>

<span class="na">ruler</span><span class="pi">:</span>
  <span class="na">storage</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">local</span>
    <span class="na">local</span><span class="pi">:</span>
      <span class="na">directory</span><span class="pi">:</span> <span class="s">/loki/rules</span>
  <span class="na">rule_path</span><span class="pi">:</span> <span class="s">/loki/rules-temp</span>
  <span class="na">alertmanager_url</span><span class="pi">:</span> <span class="s">http://localhost:9093</span>
  <span class="na">ring</span><span class="pi">:</span>
    <span class="na">kvstore</span><span class="pi">:</span>
      <span class="na">store</span><span class="pi">:</span> <span class="s">inmemory</span>
  <span class="na">enable_api</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<h2 id="参考">
<a class="anchor" href="#%E5%8F%82%E8%80%83" aria-hidden="true"><span class="octicon octicon-link"></span></a>参考</h2>
<ul>
  <li><a href="https://i101330.hatenablog.com/entry/2019/08/18/142339">Lokiとpromtailことはじめ</a></li>
  <li><a href="https://www.tmp1024.com/observe-kubernetes-all-nodes-of-prometheus/">Kubernetesの全NodeをPrometheusで監視する方法</a></li>
</ul>

  </div><a class="u-url" href="/kubernetes/2021/08/21/k3s-cluster-on-rp4.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>My lab notebook</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ar90n" title="ar90n"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ar90n" title="ar90n"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
