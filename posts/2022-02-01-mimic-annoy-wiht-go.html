<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.218">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-02-01">
<meta name="description" content="mimic annoy with go">

<title>lab_note - Goで類似ベクトルを検索する</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../logo.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/plain" cookie-consent="tracking">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-90473091-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"headline",
  "consent_type":"express",
  "palette":"dark",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  


<link rel="stylesheet" href="../styles.css">
<meta name="twitter:title" content="lab_note - Goで類似ベクトルを検索する">
<meta name="twitter:description" content="mimic annoy with go">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">lab_note</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ar90n"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ar90n"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link active" data-scroll-target="#はじめに">はじめに</a></li>
  <li><a href="#やったこと" id="toc-やったこと" class="nav-link" data-scroll-target="#やったこと">やったこと</a></li>
  <li><a href="#annoyの詳細" id="toc-annoyの詳細" class="nav-link" data-scroll-target="#annoyの詳細">Annoyの詳細</a></li>
  <li><a href="#実装詳細" id="toc-実装詳細" class="nav-link" data-scroll-target="#実装詳細">実装詳細</a></li>
  <li><a href="#ベンチマーク" id="toc-ベンチマーク" class="nav-link" data-scroll-target="#ベンチマーク">ベンチマーク</a>
  <ul class="collapse">
  <li><a href="#ann-benchmarksへアルゴリズムを追加する" id="toc-ann-benchmarksへアルゴリズムを追加する" class="nav-link" data-scroll-target="#ann-benchmarksへアルゴリズムを追加する">ann-benchmarksへアルゴリズムを追加する</a></li>
  <li><a href="#ベンチマークの実行" id="toc-ベンチマークの実行" class="nav-link" data-scroll-target="#ベンチマークの実行">ベンチマークの実行</a></li>
  <li><a href="#結果" id="toc-結果" class="nav-link" data-scroll-target="#結果">結果</a></li>
  </ul></li>
  <li><a href="#参考" id="toc-参考" class="nav-link" data-scroll-target="#参考">参考</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Goで類似ベクトルを検索する</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Go</div>
    <div class="quarto-category">Algorithm</div>
    <div class="quarto-category">MachineLearning</div>
    <div class="quarto-category">VectorSimilaritySearch</div>
  </div>
  </div>

<div>
  <div class="description">
    mimic annoy with go
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 1, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>類似ベクトル検索を実現する代表的な実装に<a href="https://github.com/spotify/annoy">Annoy</a>があります． 今回，Goの修練としてAnnoyの一部機能をGoで再実装しました．</p>
<p><a href="&quot;https://github.com/ar90n/countrymaam&quot;">countrymaam</a></p>
</section>
<section id="やったこと" class="level2">
<h2 class="anchored" data-anchor-id="やったこと">やったこと</h2>
<ul>
<li>kd-treeベースの探索アルゴリズムを実装</li>
<li>random projection treeベースの探索アルゴリズムを実装</li>
<li><a href="https://github.com/erikbern/ann-benchmarks">ann-benchmarks</a>にてベンチマークを測定</li>
</ul>
</section>
<section id="annoyの詳細" class="level2">
<h2 class="anchored" data-anchor-id="annoyの詳細">Annoyの詳細</h2>
<p>Annoyの詳細については以下のページが大変勉強になりました．</p>
<p><a href="&quot;https://techblog.zozo.com/entry/annoy-explanation&quot;">annoy-explanation</a></p>
<p>個人的には探索時のノードの取り扱い方が特に面白いと思ったので，そこの部分について少しだけ補足をしたいと思います．</p>
<p>上記ページでも解説されている通り，探索時は<code>D::pq_distance</code>の結果を優先度として優先度付きキューにノードを追加します． 以下に実際にこの処理を行う箇所のコードを示します．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  T margin <span class="op">=</span> D<span class="op">::</span>margin<span class="op">(</span>nd<span class="op">,</span> v<span class="op">,</span> _f<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  q<span class="op">.</span>push<span class="op">(</span>make_pair<span class="op">(</span>D<span class="op">::</span>pq_distance<span class="op">(</span>d<span class="op">,</span> margin<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> <span class="kw">static_cast</span><span class="op">&lt;</span>S<span class="op">&gt;(</span>nd<span class="op">-&gt;</span>children<span class="op">[</span><span class="dv">1</span><span class="op">])));</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  q<span class="op">.</span>push<span class="op">(</span>make_pair<span class="op">(</span>D<span class="op">::</span>pq_distance<span class="op">(</span>d<span class="op">,</span> margin<span class="op">,</span> <span class="dv">0</span><span class="op">),</span> <span class="kw">static_cast</span><span class="op">&lt;</span>S<span class="op">&gt;(</span>nd<span class="op">-&gt;</span>children<span class="op">[</span><span class="dv">0</span><span class="op">])));</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ここで，各変数と関数の詳細は以下の通りです．</p>
<ul>
<li><code>D</code>: ベクトル間のメトリック</li>
<li><code>D::margin</code>: クエリ<code>v</code>から際（上述の解説ページに倣います）までの符号付き距離を計算</li>
<li><code>D::pq_distance</code>: 探索するノードの優先度を計算</li>
<li><code>d</code>: 根ノードから現在のノードに至るまでの最悪の優先度</li>
<li><code>q</code>: 探索するノードを決定するための優先度付きキュー</li>
<li><code>nd</code>: 現在のノード</li>
</ul>
<p>従って，ここでは<code>D::pq_distance(d, margin, 1)</code>という優先度で<code>nd-&gt;children[1]</code>を，<code>D::pq_distance(d, margin, 0)</code>という優先度で<code>nd-&gt;children[0]</code>を，優先度キューに追加していることがわかります．</p>
<p>次に，<code>D</code>を<code>Euclidean</code>として<code>D::pq_distance</code>の詳細を示します．<code>Euclidean</code>には<code>pq_distance</code>が実装されていないため，実際には<code>Minkowski</code>の実装となります．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">inline</span> T pq_distance<span class="op">(</span>T distance<span class="op">,</span> T margin<span class="op">,</span> <span class="dt">int</span> child_nr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>child_nr <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      margin <span class="op">=</span> <span class="op">-</span>margin<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>min<span class="op">(</span>distance<span class="op">,</span> margin<span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>上記実装では，<code>child_nr==0</code>が成立する場合，<code>margin</code>の符号を反転しています． この処理の具体例を以下の図に示します． 子ノードとして<code>children[1]</code>を選択した場合を考えます．この時，<code>query1</code>に対するマージンは<code>margin1</code>，<code>query2</code>に対するマージンは<code>-margin2</code>となります． 同様に子ノードとして<code>children[0]</code>を選択した場合を考えます．この時，<code>query1</code>に対するマージンは<code>-marign1</code>, <code>query2</code>に対するマージンは<code>margin2</code>となります．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/img/2022-02-01-mimic-annoy-wiht-go/cutplane.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">cutplane</figcaption><p></p>
</figure>
</div>
<p>その結果，子ノードの優先度は当該ノードが存在する側を正とした符号付き距離となります．</p>
<p><code>distance</code>は前述の<code>d</code>（現在のノードに至るまでの最悪の優先度）が割り当てられています． 従って，<code>pq_distance</code>は優先度が悪化した場合にその値を更新する振る舞いとなっていることが解ります．</p>
<p>この性質によって，クエリが存在する側（優先度が正）のノードの探索が完了すると，クエリが存在しない側（優先度が負）のノードの探索に取り掛かります． この様に, 場合分け等を行うことなく適切に次に探索すべきノードを選択できている点が非常に面白い実装だと思いました．</p>
</section>
<section id="実装詳細" class="level2">
<h2 class="anchored" data-anchor-id="実装詳細">実装詳細</h2>
<p>今回実装した主要なインターフェースと実装の関係を以下に示します．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/img/2022-02-01-mimic-annoy-wiht-go/class.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">class</figcaption><p></p>
</figure>
</div>
<p>上図の各要素の詳細は詳細は以下のとおりです．</p>
<ul>
<li>Index: 類似ベクトル検索のインターフェース．このインターフェースを用いてデータの登録や検索を実施</li>
<li>Candidate: 検索結果を表現する構造体</li>
<li>flatIndex: 線形探索による類似ベクトル検索の実装</li>
<li>bspTreeIndex: バイナリ空間分割木による類似ベクトル検索の実装</li>
<li>CutPlane: 際のインターフェース．このインターフェースを用いて空間を分割</li>
<li>kdCutPlane: Kd-Treeを実現するための際の実装</li>
<li>rpCutPlane: Random Projection Treeを実現するための際の実装</li>
</ul>
<p>Kd-TreeとRandom Projection Treeとは際をどの様に計算するかの違いしかありません． そこで，<code>bspTreeIndex</code>と<code>CutPlane</code>の組み合わせで表現することとしました． 従って，Kd-Treeは</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go code-with-copy"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>bspTreeIndex<span class="op">[</span>T<span class="op">,</span> U<span class="op">,</span> kdCutPlane<span class="op">[</span>T<span class="op">,</span> U<span class="op">]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>と表現することができます．また，Random Projection Treeは</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go code-with-copy"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bspTreeIndex<span class="op">[</span>T<span class="op">,</span> U<span class="op">,</span> rpCutPlane<span class="op">[</span>T<span class="op">,</span> U<span class="op">]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>と表現することができます．</p>
</section>
<section id="ベンチマーク" class="level2">
<h2 class="anchored" data-anchor-id="ベンチマーク">ベンチマーク</h2>
<p>類似ベクトル検索のベンチマークに<a href="https://github.com/erikbern/ann-benchmarks">ann-benchmarks</a>があります． 今回の実装をこのベンチマークに対応させることで，既存の実装とパフォーマンスを比較しました．</p>
<section id="ann-benchmarksへアルゴリズムを追加する" class="level3">
<h3 class="anchored" data-anchor-id="ann-benchmarksへアルゴリズムを追加する">ann-benchmarksへアルゴリズムを追加する</h3>
<p>ann-benchmarksへ新規にアルゴリズムを追加するためには，以下の作業が必要となります． また，これらの修正結果は<a href="https://github.com/ar90n/countrymaam/tree/main/benchmark">こちら</a>から取得可能です．</p>
<section id="アルゴリズムが動作するイメージのdockerfileを追加" class="level4">
<h4 class="anchored" data-anchor-id="アルゴリズムが動作するイメージのdockerfileを追加">アルゴリズムが動作するイメージのDockerfileを追加</h4>
<p><code>ann-benchmarks/install/Dockefile.&lt;algorithm name&gt;</code>というファイルに追加するアルゴリズムが動作するイメージの定義を記述します． ベンチマークを実施するための共通処理は<code>ann-benchmarks</code>というイメージに実装されています． 従って，このイメージを継承して不足分を追記することになります．</p>
<p>今回はGoでアルゴリズムを実装しました． 従って，以下のように</p>
<ul>
<li>実行ファイルをビルド</li>
<li>ベンチマーク用イメージにコピー</li>
</ul>
<p>という手順を踏むこととしました．</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> golang:1.18-rc as builder</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">go</span> install github.com/ar90n/countrymaam/cmd/countrymaam@latest</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ann-benchmarks</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /go/bin/countrymaam /usr/local/bin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="類似ベクトル検索を行うプログラムを追加" class="level4">
<h4 class="anchored" data-anchor-id="類似ベクトル検索を行うプログラムを追加">類似ベクトル検索を行うプログラムを追加</h4>
<p><code>ann-benchmarks/ann_benchmarks/algorithms/&lt;algorithm name&gt;.py</code>というファイルに類似ベクトル検索を行うプログラムを記述します． 拡張子からも明らかですが，ベンチマークはPythonによって実装されています． 従って，類似ベクトル検索アルゴリズムもPythonから呼び出す必要があります． 具体的には，<code>BaseANN</code>を継承し以下のメソッドを実装します．</p>
<ul>
<li>fit: インデックスを作成します．引数として，サイズが<code>(サンプル数,次元)</code>の<code>numpy.array</code>が渡されます</li>
<li>set_query_arguments: テストセットに対する検索を行う前に一度だけ呼び出されます．検索に対するパラメータの設定を行います</li>
<li>query: 類似ベクトル検索を行います．引数としてクエリと求める類似ベクトルの数が渡されます</li>
<li>__init__: 引数として渡されたパラメータをもとにアルゴリズムの初期化します</li>
<li>__str__: 現在のパラメータとクラス名を文字列として返します</li>
</ul>
<p>今回の実装ではPythonインターフェースを実装していません． 従って，実行ファイルをサブプロセスとして起動し，パイプを経由してデータの入出力を行います． 作成したクラスを以下に示します．</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Countrymaam(BaseANN):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, metric, params):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._metric <span class="op">=</span> metric</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._index <span class="op">=</span> params.get(<span class="st">"index"</span>, <span class="st">"kd-tree"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._n_trees <span class="op">=</span> params.get(<span class="st">"n_trees"</span>, <span class="dv">8</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._leaf_size <span class="op">=</span> params.get(<span class="st">"leaf_size"</span>, <span class="dv">8</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> X.astype(np.float64)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        suffix <span class="op">=</span> <span class="st">""</span>.join(random.choices(string.ascii_lowercase, k<span class="op">=</span><span class="dv">16</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        index_file_path <span class="op">=</span> <span class="ss">f"index_</span><span class="sc">{</span>suffix<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>os<span class="sc">.</span>getpid()<span class="sc">}</span><span class="ss">.bin"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># インデックスを作成し，ファイルに書き出す</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> subprocess.Popen([</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"countrymaam"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--dim"</span>, <span class="bu">str</span>(<span class="bu">len</span>(X[<span class="dv">0</span>])),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--index"</span>, <span class="va">self</span>._index,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--leaf-size"</span>, <span class="bu">str</span>(<span class="va">self</span>._leaf_size),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--tree-num"</span>, <span class="bu">str</span>(<span class="va">self</span>._n_trees),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--output"</span>, index_file_path</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        ], stdin<span class="op">=</span>subprocess.PIPE)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        p.stdin.write(struct.pack(<span class="ss">f"=</span><span class="sc">{</span>X<span class="sc">.</span>size<span class="sc">}</span><span class="ss">d"</span>, <span class="op">*</span>np.ravel(X)))</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        p.communicate()</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        p.stdin.close()</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># インデックスを読み，クエリの入力を待機する</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pipe <span class="op">=</span> subprocess.Popen([</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"countrymaam"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"predict"</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--dim"</span>, <span class="bu">str</span>(<span class="bu">len</span>(X[<span class="dv">0</span>])),</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--index"</span>, <span class="va">self</span>._index,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--input"</span>, index_file_path</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        ], stdin<span class="op">=</span>subprocess.PIPE, stdout<span class="op">=</span>subprocess.PIPE)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_query_arguments(<span class="va">self</span>, search_k):</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._search_k <span class="op">=</span> search_k <span class="co"># 探索ノード数を設定</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> query(<span class="va">self</span>, v, n):</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> v.astype(np.float64)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pipe.stdin.write(struct.pack(<span class="ss">f"=i"</span>, <span class="va">self</span>._search_k)) <span class="co"># 探索ノード数</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pipe.stdin.write(struct.pack(<span class="ss">f"=i"</span>, n)) <span class="co"># 検索する類似ベクトル数</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pipe.stdin.write(struct.pack(<span class="ss">f"=</span><span class="sc">{</span>v<span class="sc">.</span>size<span class="sc">}</span><span class="ss">d"</span>, <span class="op">*</span>v)) <span class="co"># クエリベクトル</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._pipe.stdin.flush()</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        rn <span class="op">=</span> struct.unpack(<span class="st">"=i"</span>, <span class="va">self</span>._pipe.stdout.read(<span class="dv">4</span>))[<span class="dv">0</span>]</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> rn</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(rn):</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            ret[i] <span class="op">=</span> struct.unpack(<span class="st">"=i"</span>, <span class="va">self</span>._pipe.stdout.read(<span class="dv">4</span>))[<span class="dv">0</span>]</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(ret)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"Countrymaam(index=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>_index<span class="sc">}</span><span class="ss">, leaf_size=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>_leaf_size<span class="sc">}</span><span class="ss"> n_trees=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>_n_trees<span class="sc">}</span><span class="ss">, search_k=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>_search_k<span class="sc">}</span><span class="ss">)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ベンチマークの設定ファイルにアルゴリズムの設定を追加" class="level4">
<h4 class="anchored" data-anchor-id="ベンチマークの設定ファイルにアルゴリズムの設定を追加">ベンチマークの設定ファイルにアルゴリズムの設定を追加</h4>
<p>ベンチマークに関する設定は<code>ann-benchmarks/algos.yaml</code>というファイルに追記します． このファイルは<code>データ型</code> -&gt; <code>メトリック</code> -&gt; <code>アルゴリズム</code> という階層構造になっています． 従って，各アルゴリズムがサポートしているデータ型とメトリックに応じて，適切な位置に設定を記述する必要があります．</p>
<p>データ型とメトリックの組み合わせは以下の通りです．</p>
<ul>
<li>float
<ul>
<li>any</li>
<li>euclidean</li>
<li>angular</li>
</ul></li>
<li>bit
<ul>
<li>hamming</li>
<li>jaccard</li>
</ul></li>
</ul>
<p>今回実装したアルゴリズムはユークリッド距離にのみ対応しているため<code>euclidean</code>に追記します．</p>
<p>アルゴリズムの階層に記述するパラメータは以下の通りです．</p>
<ul>
<li>docker-tag: 使用するDockerイメージのタグ</li>
<li>module: アルゴリズムが実装されているモジュール</li>
<li>constructor: アルゴリズムの実装クラス</li>
<li>base-args: 全計測に渡ってconstructorに渡される引数の共通部分</li>
<li>run-groups: constructorとset_query_arguments渡される引数の可変部分</li>
</ul>
<p>最終的な差分は以下の様になりました．</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode diff code-with-copy"><code class="sourceCode diff"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff --git a/algos.yaml b/algos.yaml</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>index 7c1ebe6..f170633 100644</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dt">--- a/algos.yaml</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/algos.yaml</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -391,6 +391,28 @@ float:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>           query-args: [[0.6, 0.8, 0.9, 1.0, 1.02, 1.05, 1.1, 1.2]]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>   euclidean:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="va">+    countrymaam-kd:</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="va">+      docker-tag: ann-benchmarks-countrymaam</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="va">+      module: ann_benchmarks.algorithms.countrymaam</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="va">+      constructor: Countrymaam</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="va">+      base-args: ["@metric"]</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="va">+      run-groups:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="va">+        kd:</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="va">+          arg-groups:</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="va">+            - {"index": ["rkd-tree"], "n_trees": [8, 16, 32, 64],</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="va">+               "leaf_size":[8, 16, 32, 64]}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="va">+          query-args: [[16, 32, 64, 128, 256, 512, 1024, 2048]]</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="va">+    countrymaam-rp:</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="va">+      docker-tag: ann-benchmarks-countrymaam</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="va">+      module: ann_benchmarks.algorithms.countrymaam</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="va">+      constructor: Countrymaam</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="va">+      base-args: ["@metric"]</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="va">+      run-groups:</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="va">+        rp:</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="va">+          arg-groups:</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="va">+            - {"index": ["rrp-tree"], "n_trees": [8, 16, 32, 64],</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="va">+               "leaf_size":[8, 16, 32, 64]}</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="va">+          query-args: [[16, 32, 64, 128, 256, 512, 1024, 2048]]</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>     vamana(diskann):</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>       docker-tag: ann-benchmarks-diskann</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>       module: ann_benchmarks.algorithms.diskann</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>run-groups</code>における<code>arg-groups</code>が<code>__init__</code>に渡されるパラメータを，<code>query-args</code>が<code>set_query_arguments</code>に渡されるパラメータを表します． <code>arg-groups</code>の様に複数の属性からなるパラメータは各属性の直積が渡されます．</p>
</section>
</section>
<section id="ベンチマークの実行" class="level3">
<h3 class="anchored" data-anchor-id="ベンチマークの実行">ベンチマークの実行</h3>
<p>ベンチマークは以下のコマンドで実行します．<code>install.py</code>はコンテナの作成を，<code>run.py</code>はベンチマークを実行します． <code>&lt;algorithm name&gt;</code>と<code>&lt;dataset name&gt;</code>は省略可能です．省略した場合，適用可能な全てのアルゴリズムまたはデータセットに対して処理を適用します．</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python install.py <span class="at">--algorithm</span> <span class="op">&lt;</span>algorithm name<span class="op">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python run.py <span class="at">--algorithm</span> <span class="op">&lt;</span>algorithm name<span class="op">&gt;</span> --dataset <span class="op">&lt;</span>dataset name<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="結果" class="level3">
<h3 class="anchored" data-anchor-id="結果">結果</h3>
<p>以下の結果は，fashion-mnistに対するベンチマークです．図中の<code>flann</code>と<code>annoy</code>は<code>ann-benchmarks</code>のデフォルト設定を用いています．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/img/2022-02-01-mimic-annoy-wiht-go/fashion-mnist-784-euclidean.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">result</figcaption><p></p>
</figure>
</div>
<ul>
<li>CPU: AMD Ryzen 9 3950X</li>
<li>Memory: 64GB</li>
</ul>
</section>
</section>
<section id="参考" class="level2">
<h2 class="anchored" data-anchor-id="参考">参考</h2>
<ul>
<li>Fashion-MNIST: a Novel Image Dataset for Benchmarking Machine Learning Algorithms, Han Xiao and Kashif Rasul and Roland Vollgraf, 2017</li>
<li><a href="https://github.com/erikbern/ann-benchmarks">ann-benchmarks</a></li>
<li><a href="https://github.com/spotify/annoy">Annoy</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
  </div>
</footer>



</body></html>