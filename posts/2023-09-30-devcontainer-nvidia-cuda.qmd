---
title: devcontainersã§CUDAç’°å¢ƒã‚’æ•´ãˆã‚‹
date: 2023-09-30
categories: [é–‹ç™ºç’°å¢ƒ]
image: /assets/img/common/devcontainers.svg
format:
  html:
    code-fold: true
toc: true
layout: post
code-annotations: below
---

## ã¯ã˜ã‚ã«
devcontainersã®Featuresã‚’ä½¿ç”¨ã—ã¦ã„ã„æ„Ÿã˜ã«CUDAé–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹ã“ã¨ãŒã§ããŸã®ã§ã€ãã®ãƒ¡ãƒ¢ã§ã™ã€‚

## ã‚„ã£ãŸã“ã¨

* CUDAé–‹ç™ºç’°å¢ƒã‚’ä¸€å¼å°å…¥ã™ã‚‹`devcontainer.json`ã‚’ä½œæˆ
* Visual Studio Codeã§Python + Poetry + CUDAãªç’°å¢ƒã‚’æ‰‹è»½ã«ä½œæˆ

## `devcontainer.json`ã‚’ç”¨ã„ãŸCUDAé–‹ç™ºç’°å¢ƒã®è¨­å®š

devcontainersã®Featuresã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€äº‹å‰ã«æº–å‚™ã•ã‚Œã¦ã„ã‚‹å„ç¨®æ©Ÿèƒ½ã‚’æ‰‹è»½ã«é–‹ç™ºç”¨ã‚³ãƒ³ãƒ†ãƒŠã«å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€ [ghcr.io/devcontainers/features/nvidia-cuda](https://github.com/devcontainers/features/tree/main/src/nvidia-cuda) ã‚’ä½¿ç”¨ã—ã¦ã€CUDAã‚’é–‹ç™ºç”¨ã‚³ãƒ³ãƒ†ãƒŠã«å°å…¥ã—ã¾ã™ã€‚

ä»Šå›ä½œæˆã—ãŸ`devcontainer.json`ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¨­å®šã§ã¯ã€Pythonã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã«CUDAé–‹ç™ºç’°å¢ƒã‚’å°å…¥ã—ã¦ã„ã¾ã™ã€‚ã“ã®éš›ã€cuDNNã®é–‹ç™ºç’°å¢ƒã¨CUDA Toolkitã‚’è¿½åŠ ã§å°å…¥ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€CUDAã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯12.2ã‚’ã€cuDNNã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯8.9.5.29ã‚’ãã‚Œãã‚ŒæŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`runArgs`ã«ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã‹ã‚‰GPUã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€`--gpus all`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚`remoteEnv`ã«ã¯`nvcc`ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

```json
{
    "name": "python3",
    "image": "mcr.microsoft.com/devcontainers/python:3.10",
    "features": {
            "ghcr.io/devcontainers/features/nvidia-cuda:1": {
                "installCudnnDev": true,
                "installToolkit": true,
                "cudaVersion": "12.2",
                "cudnnVersion": "8.9.5.29"
            }
    },
    "runArgs": [
        "--gpus",
        "all"
    ],
    "hostRequirements": {
        "gpu": "optional"
    },
    "remoteEnv": {
        "PATH": "${containerEnv:PATH}:/usr/local/cuda/bin"
    },
    "remoteUser": "root"
}
```

å®Ÿéš›ã«`devcontainer cli`ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ã„ã¿ã¾ã™ã€‚

```bash
$ find .
.
./.devcontainer
./.devcontainer/devcontainer.json

$ devcontainer up --workspace-folder .
[1 ms] @devcontainers/cli 0.51.3. Node.js v16.20.0. linux 6.2.0-33-generic x64.
{"outcome":"success","containerId":"1619d2fb2382a658276da2775602097b69c1157a65938485089f8ffa2c643e3e","remoteUser":"root","remoteWorkspaceFolder":"/workspaces/lab/sandbox/nvidia_cuda_devcontainer"}

$ devcontainer exec  --workspace-folder .  nvidia-smi
Sat Sep 30 12:57:23 2023
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 525.125.06   Driver Version: 525.125.06   CUDA Version: 12.0     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  Off  | 00000000:06:00.0 Off |                  N/A |
| 40%   29C    P8    N/A /  75W |      1MiB /  4096MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA GeForce ...  Off  | 00000000:0A:00.0 Off |                  N/A |
|  0%   34C    P8    14W / 170W |      1MiB / 12288MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
```

`nvidia-smi`ãŒé©åˆ‡ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

## Visual Studio Codeã‚’ç”¨ã„ãŸPython + Poetry + CUDAãªç’°å¢ƒã®æ§‹ç¯‰

`devcontainer cli`ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã‚‚ååˆ†ä¾¿åˆ©ãªã®ã§ã™ãŒã€Visual Studio Codeã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã¨ã•ã‚‰ã«æ—ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã®æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚

ã¾ãšã€ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã‚ˆã‚Š`Dev Containers: Open Folder in Container ...`ã‚’é¸æŠã—ã¦ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc0.jpg)

æ¬¡ã«ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ç’°å¢ƒã¨ã—ã¦`python with poetry`ã‚’é¸æŠã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc2.jpg)

ãã—ã¦ã€ä½¿ç”¨ã™ã‚‹Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc3.jpg)

ãƒ›ã‚¹ãƒˆOSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc4.jpg)

æ¬¡ã«ä½¿ç”¨ã™ã‚‹Featureã‚’é¸æŠã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€`NVIDIA CUDA`ã‚’é¸æŠã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc5.jpg)

ä»Šå›ã¯`cuDNN`ã¨`CUDA Toolkit`ã‚’è¿½åŠ ã§å°å…¥ã™ã‚‹ãŸã‚ã€`Configure Options`ã‚’é¸æŠã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc6.jpg)

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€`installCudnnDev`ã¨`installToolkit`ã‚’é¸æŠã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc7.jpg)

ãã—ã¦ã€CUDAã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯`12.2`ã‚’é¸æŠã—ã¾ã—ãŸã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc8.jpg)

åŒæ§˜ã«`cuDNN`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯`8.9.5.29`ã‚’é¸æŠã—ã¾ã—ãŸã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc9.jpg)

ä»¥ä¸Šã®æ“ä½œã‚’å®Œäº†ã™ã‚‹ã¨ã€å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆãŒå§‹ã¾ã‚Šã¾ã™ã€‚
ã—ã°ã‚‰ãæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¾ã™ã€‚

![](/assets/img/2023-09-30-devcontainer-nvidia-cuda/sc10.jpg)

ä½œæˆã•ã‚ŒãŸ`devcontainer.json`ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```bash
{
        "name": "poetry3-poetry-pyenv",
        "build": {
                "dockerfile": "Dockerfile"
        },

        // ğŸ‘‡ Features to add to the Dev Container. More info: https://containers.dev/implementors/features.
        // "features": {},

        // ğŸ‘‡ Use 'forwardPorts' to make a list of ports inside the container available locally.
        // "forwardPorts": [],

        // ğŸ‘‡ Use 'postCreateCommand' to run commands after the container is created.
        // "postCreateCommand": "",

        // ğŸ‘‡ Configure tool-specific properties.
        "customizations": {
        "vscode": {
            "extensions":["ms-python.python", "njpwerner.autodocstring"]
            }
                },
                "features": {
                        "ghcr.io/devcontainers/features/nvidia-cuda:1": {
                                "installCudnnDev": true,
                                "installToolkit": true,
                                "cudaVersion": "12.2",
                                "cudnnVersion": "8.9.5.29"
                        }
                }

        // ğŸ‘‡ Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
        // "remoteUser": "root"
}
```

ã“ã®ã¾ã¾ã§ã¯è¨­å®šãŒä¸ååˆ†ã§ã‚ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰GPUã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãã“ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®è¨­å®šã§ã¯ã€`remoteUser`ã‚’`root`ã¨ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ç§ã®ç’°å¢ƒã§ã¯å¿…è¦ãªãŸã‚è¨­å®šã—ã¦ã„ã¾ã™ã€‚å¾“ã„ã¾ã—ã¦ã€å¿…é ˆã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```diff
29,30c29,36
<               }
<
---
>               },
>       "runArgs": [
>               "--gpus",
>               "all"
>       ],
>       "remoteEnv": {
>               "PATH": "${containerEnv:PATH}:/usr/local/cuda/bin"
>       },
32c38
<       // "remoteUser": "root"
---
>       "remoteUser": "root"
```

ãã®å¾Œã€å†åº¦ã‚³ãƒ³ãƒ†ãƒŠä½œã‚Šç›´ã™ï¼ˆRebuild...ã‚’å®Ÿè¡Œï¼‰ã¨GPUãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã®ã€ã‚³ãƒ³ãƒ†ãƒŠå†ä½œæˆã¯æœ¬æ¥ã¯å¿…è¦ç„¡ã„æ°—ãŒã™ã‚‹ã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ç›´ã™ã ã‘ã§ã‚‚ååˆ†ã ã£ãŸæ°—ãŒã—ã¾ã™ã€‚

å®Ÿéš›ã«PyTorchã‚’ä½¿ã£ã¦mnistã‚’å­¦ç¿’ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚ä»Šæ›´ã§ã™ãŒã€PyTorchã§ã®é‹ç”¨ã‚’è€ƒãˆã‚‹ã¨CUDAã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯11.8ã«ã—ã¦ãŠãã®ãŒè‰¯ã‹ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```bash
$ poetry init -q
$ poetry source add torch_cu118 --priority=explicit https://download.pytorch.org/whl/cu118
Adding source with name torch_cu118.
$ poetry add torch torchvision --source torch_cu118
Creating virtualenv nvidia-cuda-demo-4E4T6yr2-py3.10 in /root/.cache/pypoetry/virtualenvs
Using version ^2.0.1+cu118 for torch
Using version ^0.15.2+cu118 for torchvision

Updating dependencies

...


  â€¢ Installing numpy (1.25.2)
  â€¢ Installing pillow (10.0.1)
  â€¢ Installing requests (2.31.0)
  â€¢ Installing torch (2.0.1+cu118)
  â€¢ Installing torchvision (0.15.2+cu118)

Writing lock file
$ curl -L -O https://raw.githubusercontent.com/pytorch/examples/main/mnist/main.py
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  5644  100  5644    0     0  14481      0 --:--:-- --:--:-- --:--:-- 14471
$ poetry run python main.py
Downloading http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz
Downloading http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz to ../data/MNIST/raw/train-images-idx3-ubyte.gz
100.0%
Extracting ../data/MNIST/raw/train-images-idx3-ubyte.gz to ../data/MNIST/raw

...

Train Epoch: 14 [58240/60000 (97%)]     Loss: 0.014492
Train Epoch: 14 [58880/60000 (98%)]     Loss: 0.004552
Train Epoch: 14 [59520/60000 (99%)]     Loss: 0.001017

Test set: Average loss: 0.0252, Accuracy: 9924/10000 (99%)
```

ã“ã®éš›ã€ãƒ›ã‚¹ãƒˆå´ã‹ã‚‰`nvidia-smi`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ã“ã®ã“ã¨ã‹ã‚‰ã€é©åˆ‡ã«GPUã‚’ä½¿ç”¨ã—ãŸå­¦ç¿’ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```bash
$ nvidia-smi
Sat Sep 30 13:57:07 2023
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 525.125.06   Driver Version: 525.125.06   CUDA Version: 12.0     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  NVIDIA GeForce ...  Off  | 00000000:06:00.0 Off |                  N/A |
| 40%   29C    P8    N/A /  75W |      3MiB /  4096MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
|   1  NVIDIA GeForce ...  Off  | 00000000:0A:00.0 Off |                  N/A |
|  0%   42C    P2    54W / 170W |   1905MiB / 12288MiB |     24%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|    1   N/A  N/A     77582      C   ...E4T6yr2-py3.10/bin/python     1902MiB |
+-----------------------------------------------------------------------------+
```

ã“ã®ã‚ˆã†ã«Visual Studio Codeã‹ã‚‰ã¯Python + Poetry + CUDAã®ç’°å¢ƒã‚’ç°¡å˜ã«ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ä»Šå›ã¯CUDAã®é–‹ç™ºç’°å¢ƒã‚‚åˆã‚ã›ã¦å°å…¥ã—ã¾ã—ãŸãŒã€ä»»æ„ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Pythonã‚’ç°¡å˜ã«å°å…¥ã§ãã‚‹ãŸã‚ã€Python + Poetryã ã‘ã§ã‚‚ååˆ†ä¾¿åˆ©ã ã¨æ€ã„ã¾ã™ã€‚