Bootstrap: localimage
From: ../images/common.simg

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/opt/init/010_python

%files
    jupyter-server /opt/bin
    entry.sh /opt/init/010_python/entry.sh
    python_dein.toml /opt/init/010_python/python_dein.toml

%environment
    export PATH=/opt/bin:/opt/miniconda3/bin:$PATH

%labels
    AUTHOR argon.argon.argon@gmail.com

%post
    echo "export SINGULARITY_IMAGE_NAME=python_$(date +%s)" >> $SINGULARITY_ENVIRONMENT
    echo "export SINGULARITY_XDG_ROOT=\$HOME/.xdg/\$SINGULARITY_IMAGE_NAME" >> $SINGULARITY_ENVIRONMENT
    echo "export XDG_CONFIG_HOME=\$SINGULARITY_XDG_ROOT" >> $SINGULARITY_ENVIRONMENT
    echo "export XDG_DATA_HOME=\$SINGULARITY_XDG_ROOT" >> $SINGULARITY_ENVIRONMENT
    echo "export XDG_RUNTIME_DIR=\$SINGULARITY_XDG_ROOT" >> $SINGULARITY_ENVIRONMENT
    echo "export JUPYTER_CONFIG_DIR=\$SINGULARITY_XDG_ROOT/jupyter" >> $SINGULARITY_ENVIRONMENT

    curl -o /tmp/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash /tmp/miniconda.sh -b -p /opt/miniconda3
    rm  /tmp/miniconda.sh

    /opt/miniconda3/bin/pip install sagemaker

    /opt/miniconda3/bin/conda install -y tensorflow
    /opt/miniconda3/bin/conda install -y -c pytorch pytorch
    /opt/miniconda3/bin/conda install -y -c conda-forge xgboost lightgbm
    /opt/miniconda3/bin/conda install -y jupyter
    /opt/miniconda3/bin/conda install -y -c conda-forge jupyter_contrib_nbextensions jupyter_nbextensions_configurator ipywidgets
    /opt/miniconda3/bin/conda install -y -c damianavila82 rise
    /opt/miniconda3/bin/conda install -y -c r libiconv
    /opt/miniconda3/bin/conda install -y -c conda-forge gdcm pydicom nibabel
    /opt/miniconda3/bin/conda install -y -c simpleitk simpleitk
    /opt/miniconda3/bin/conda install -y -c conda-forge numpy scipy scikit-learn scikit-image matplotlib seaborn bokeh holoviews pillow networkx
    /opt/miniconda3/bin/conda install -y -c conda-forge pandas pandas-datareader
    /opt/miniconda3/bin/conda install -y -c conda-forge coconut flexx pudb asciimatics mypy monkeytype
    /opt/miniconda3/bin/conda install -y -c conda-forge flask tinydb scrapy requests hy click
    /opt/miniconda3/bin/conda install -y -c conda-forge black jedi pytest pytest-xdist python-language-server
    /opt/miniconda3/bin/conda install -y -c conda-forge dash dash-renderer dash-html-components dash-core-components plotly
    /opt/miniconda3/bin/conda install -y -c conda-forge cython numba
    /opt/miniconda3/bin/conda clean -t
    /opt/miniconda3/bin/pip install pipenv pyls-black pyls-isort

    curl -L -o /opt/bin/vast https://raw.githubusercontent.com/vast-ai/vast-python/master/vast.py
    chmod +x /opt/bin/vast
